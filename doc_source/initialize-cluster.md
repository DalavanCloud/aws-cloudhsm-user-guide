# Getting Started with AWS CloudHSM: Initialize the Cluster<a name="initialize-cluster"></a>

Complete the steps in the following topics to initialize your AWS CloudHSM cluster\.

**Note**  
Before you initialize the cluster, review the process by which you can verify the identity and authenticity of the HSMs\. The process is optional, but it works only until a cluster is initialized\. After the cluster is initialized, you cannot use this process to get the certificates or verify the HSMs\.


+ [Get the Cluster's Certificate Signing Request \(CSR\)](#get-csr)
+ [Sign the CSR](#sign-csr)
+ [Initialize the Cluster](#initialize)

## Get the Cluster's Certificate Signing Request \(CSR\)<a name="get-csr"></a>

Before you can initialize the cluster, you get \(and then later sign\) a certificate signing request \(CSR\) that is generated by the cluster's first HSM\. If you followed the steps to verify the identity of your cluster's HSM, you already have the CSR and you can proceed to sign the CSR\. Otherwise, get the CSR now by using the [AWS CloudHSM console](https://console.aws.amazon.com/cloudhsm/), the [AWS Command Line Interface \(AWS CLI\)](https://aws.amazon.com/cli/), or the AWS CloudHSM API\.

**To get the CSR \(console\)**

1. Open the AWS CloudHSM console at [https://console\.aws\.amazon\.com/cloudhsm/](https://console.aws.amazon.com/cloudhsm/)\.

1. Choose **Initialize** next to the cluster that you created previously\.

1. When the CSR is ready, you see a link to download it\.  
![\[Download certificate signing request page in the AWS CloudHSM console.\]](http://docs.aws.amazon.com/cloudhsm/latest/userguide/images/console-download-certificates.png)

   Choose **Cluster CSR** to download and save the CSR\.

**To get the CSR \(AWS CLI\)**

+ At a command prompt, run the following [describe\-clusters](http://docs.aws.amazon.com/cli/latest/reference/cloudhsmv2/describe-clusters.html) command, which extracts the CSR and saves it to a file\. Replace *<cluster ID>* with the ID of the cluster that you created previously\.

  ```
  $ aws cloudhsmv2 describe-clusters --filters clusterIds=<cluster ID> \
                                     --output text \
                                     --query 'Clusters[].Certificates.ClusterCsr' \
                                     > <cluster ID>_ClusterCsr.csr
  ```

**To get the CSR \(AWS CloudHSM API\)**

+ Send a [http://docs.aws.amazon.com/cloudhsm/latest/APIReference/API_DescribeClusters.html](http://docs.aws.amazon.com/cloudhsm/latest/APIReference/API_DescribeClusters.html) request, then extract and save the CSR from the response\.

## Sign the CSR<a name="sign-csr"></a>

To sign the cluster's CSR, you typically use a private certificate authority \(CA\)\. Your CA signs the CSR, which creates a signed certificate\. Then you provide the signed certificate and your CA's issuing certificate to initialize the cluster\.

If you don't have a CA, you can use the following OpenSSL commands to create a self\-signed certificate and use it as your issuing certificate\.

**Important**  
The following example is a proof\-of\-concept demonstration only\. For production systems, use a more secure method \(such as a CA\) to sign the CSR\.  
The certificate that you use is not designed to be rotated\. It demonstrates that you extended trust to this cluster by signing the cluster certificate\. We recommend that you create and use a certificate that is valid for ten years\. 

**To sign the cluster's CSR \(OpenSSL\)**

1. Use the following command to create a private key\.

   ```
   $ openssl genrsa -aes256 -out customerCA.key 2048
   Generating RSA private key, 2048 bit long modulus
   ........+++
   ............+++
   e is 65537 (0x10001)
   Enter pass phrase for customerCA.key:
   Verifying - Enter pass phrase for customerCA.key:
   ```

1. Use the following command to create a self\-signed issuing certificate with the private key that you created in the previous step\. The certificate is valid for 10 years \(3652 days\)\. Read the on\-screen instructions and follow the prompts to provide identifying information for the issuing certificate\.

   ```
   $ openssl req -new -x509 -days 3652 -key customerCA.key -out customerCA.crt
   Enter pass phrase for customerCA.key:
   You are about to be asked to enter information that will be incorporated
   into your certificate request.
   What you are about to enter is what is called a Distinguished Name or a DN.
   There are quite a few fields but you can leave some blank
   For some fields there will be a default value,
   If you enter '.', the field will be left blank.
   -----
   Country Name (2 letter code) [AU]:
   State or Province Name (full name) [Some-State]:
   Locality Name (eg, city) []:
   Organization Name (eg, company) [Internet Widgits Pty Ltd]:
   Organizational Unit Name (eg, section) []:
   Common Name (e.g. server FQDN or YOUR name) []:
   Email Address []:
   ```

   When completed, this command creates a file named `customerCA.crt`\. Use this file as your issuing certificate \(trust anchor\) when you initialize the cluster\.

1. Sign the cluster's CSR with your issuer\. Replace *<cluster ID>* with the ID of the cluster that you created previously\. This signature is also valid for 10 years\.

   ```
   $ openssl x509 -req -days 3652 -in <cluster ID>_ClusterCsr.csr \
                                 -CA customerCA.crt \
                                 -CAkey customerCA.key \
                                 -CAcreateserial \
                                 -out <cluster ID>_CustomerHsmCertificate.crt
   Signature ok
   subject=/C=US/ST=CA/O=Cavium/OU=N3FIPS/L=SanJose/CN=HSM:<HSM identifer>:PARTN:<partition number>, for FIPS mode
   Getting CA Private Key
   Enter pass phrase for customerCA.key:
   ```

   This command creates a file named `<cluster ID>_CustomerHsmCertificate.crt`\. Use this file as the signed certificate when you initialize the cluster\.

## Initialize the Cluster<a name="initialize"></a>

To initialize your cluster, you provide the signed HSM certificate and your issuing certificate \(trust anchor\)\. You can initialize your cluster with the [AWS CloudHSM console](https://console.aws.amazon.com/cloudhsm/), the [AWS CLI](https://aws.amazon.com/cli/), or the AWS CloudHSM API\.

**To initialize a cluster \(console\)**

1. Open the AWS CloudHSM console at [https://console\.aws\.amazon\.com/cloudhsm/](https://console.aws.amazon.com/cloudhsm/)\.

1. Choose **Initialize** next to the cluster that you created previously\.

1. On the **Download certificate signing request** page, choose **Next**\. If **Next** is not available, first choose one of the CSR or certificate links\. Then choose **Next**\.

1. On the **Sign certificate signing request \(CSR\)** page, choose **Next**\.

1. On the **Upload the certificates** page, do the following:

   1. Next to **Cluster certificate**, choose **Upload file**\. Then select the HSM certificate that you signed previously\. If you completed the steps in the previous section, select the file named `<cluster ID>_CustomerHsmCertificate.crt`\.

   1. Next to **Issuing certificate**, choose **Upload file**\. Then select your CA's issuing certificate\. If you completed the steps in the previous section, select the file named `customerCA.crt`\.

      If you used a CA to issue the cluster certificate, provide a certificate chain that begins with the certificate that issued the cluster certificate and ends with the CA's root certificate\. The certificate chain must be in PEM format and can contain a maximum of 5000 characters\.

   1. Choose **Upload and initialize**\.

**To initialize a cluster \(AWS CLI\)**

+ At a command prompt, issue the [initialize\-cluster](http://docs.aws.amazon.com/cli/latest/reference/cloudhsmv2/initialize-cluster.html) command\. Provide the following:

  + The ID of the cluster that you created previously\.

  + The HSM certificate that you signed previously\. If you completed the steps in the previous section, it's saved in a file named `<cluster ID>_CustomerHsmCertificate.crt`\.

  + Your CA's issuing certificate\. If you completed the steps in the previous section, it's saved in a file named `customerCA.crt`\.

    If you used a CA to issue the cluster certificate, provide a certificate chain that begins with the certificate that issued the cluster certificate and ends with the CA's root certificate\. The certificate chain must be in PEM format and can contain a maximum of 5000 characters\.

  ```
  $ aws cloudhsmv2 initialize-cluster --cluster-id <cluster ID> \
                                      --signed-cert file://<cluster ID>_CustomerHsmCertificate.crt \
                                      --trust-anchor file://customerCA.crt
  {
      "State": "INITIALIZE_IN_PROGRESS",
      "StateMessage": "Cluster is initializing. State will change to INITIALIZED upon completion."
  }
  ```

**To initialize a cluster \(AWS CloudHSM API\)**

+ Send an [http://docs.aws.amazon.com/cloudhsm/latest/APIReference/API_InitializeCluster.html](http://docs.aws.amazon.com/cloudhsm/latest/APIReference/API_InitializeCluster.html) request with the following:

  + The ID of the cluster that you created previously\.

  + The HSM certificate that you signed previously\.

  + Your CA's issuing certificate\.

After you initialize the cluster, proceed to [Launch a Client Instance](launch-client-instance.md)\.