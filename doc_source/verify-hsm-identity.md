# \(Optional\) Verify the Identity and Authenticity of Your Cluster's HSM<a name="verify-hsm-identity"></a>

To initialize your cluster, you sign a certificate signing request \(CSR\) generated by the cluster's first HSM\. Before you do this, you might want to verify the identity and authenticity of the HSM\. This process is optional\.


+ [Overview](#verify-hsm-overview)
+ [Get Certificates from the HSM](#get-certificates)
+ [Verify Certificate Chains](#verify-certificate-chains)
+ [Extract and Compare Public Keys](#compare-public-keys)
+ [AWS CloudHSM Root Certificate](root-certificate.md)

## Overview<a name="verify-hsm-overview"></a>

To verify the identity of your cluster's first HSM, complete the following steps:

1. Get the certificates and CSR – In this step, you get three certificates and a CSR from the HSM\. You also get two root certificates, one from AWS CloudHSM and one from the HSM hardware manufacturer\.

1. Verify the certificate chains – In this step, you construct two certificate chains, one to the AWS CloudHSM root certificate and one to the manufacturer root certificate\. Then you verify the HSM certificate with these certificate chains to determine that AWS CloudHSM and the hardware manufacturer both attest to the identity and authenticity of the HSM\.

1. Compare public keys – In this step, you extract and compare the public keys in the HSM certificate and the cluster CSR, to ensure that they are the same\. This should give you confidence that the CSR was generated by an authentic, trusted HSM\.

The following diagram shows the CSR, the certificates, and their relationship to each other\. The subsequent list defines each certificate\.

![\[Diagram of the HSM certificates and their relationships.\]](http://docs.aws.amazon.com/cloudhsm/latest/userguide/images/hsm-certificate-relationships.png)

**AWS Root Certificate**  
This is AWS CloudHSM's root certificate\. You can view and download this certificate at https://docs\.aws\.amazon\.com/cloudhsm/latest/userguide/root\-certificate\.html\.

**Manufacturer Root Certificate**  
This is the hardware manufacturer's root certificate\. You can view and download this certificate at [https://www\.cavium\.com/LS/TAmanuCert/](https://www.cavium.com/LS/TAmanuCert/)\.

**AWS Hardware Certificate**  
AWS CloudHSM created this certificate when it claimed the HSM hardware\. Your cluster's HSM is a virtual device that runs on specialized, FIPS\-validated hardware\. This certificate asserts that AWS CloudHSM owns the hardware\.

**Manufacturer Hardware Certificate**  
The HSM hardware manufacturer created this certificate when it manufactured the HSM hardware\. This certificate asserts that the manufacturer created the hardware\.

**HSM Certificate**  
The HSM hardware created this certificate was it created the cluster's virtual HSM device\. This certificate asserts that the HSM hardware created the virtual HSM\.

**Cluster CSR**  
The virtual HSM device created this CSR\. To initialize and claim your cluster, you sign this CSR\.

## Get Certificates from the HSM<a name="get-certificates"></a>

To verify the identity and authenticity of your HSM, start by getting a CSR and five certificates\. You get three of the certificates from the HSM, which you can do with the [AWS CloudHSM console](https://console.aws.amazon.com/cloudhsm/), the [AWS Command Line Interface \(AWS CLI\)](https://aws.amazon.com/cli/), or the AWS CloudHSM API\.

**To get the CSR and HSM certificates \(console\)**

1. Open the AWS CloudHSM console at [https://console\.aws\.amazon\.com/cloudhsm/](https://console.aws.amazon.com/cloudhsm/)\.

1. Choose **Initialize** next to the cluster that you created previously\.

1. When the certificates and CSR are ready, you see links to download them\.  
![\[Download certificate signing request page in the AWS CloudHSM console.\]](http://docs.aws.amazon.com/cloudhsm/latest/userguide/images/console-download-certificates.png)

   Choose each link to download the CSR and certificates, saving each file\.

**To get the CSR and HSM certificates \(AWS CLI\)**

+ At a command prompt, issue the [describe\-clusters](http://docs.aws.amazon.com/cli/latest/reference/cloudhsmv2/describe-clusters.html) command four times, extracting the CSR and different certificates each time and saving them to files\.

  1. Issue the following command to extract the cluster CSR\. Replace *<cluster ID>* with the ID of the cluster that you created previously\.

     ```
     $ aws cloudhsmv2 describe-clusters --filters clusterIds=<cluster ID> \
                                        --output text \
                                        --query 'Clusters[].Certificates.ClusterCsr' \
                                        > <cluster ID>_ClusterCsr.csr
     ```

  1. Issue the following command to extract the HSM certificate\. Replace *<cluster ID>* with the ID of the cluster that you created previously\.

     ```
     $ aws cloudhsmv2 describe-clusters --filters clusterIds=<cluster ID> \
                                        --output text \
                                        --query 'Clusters[].Certificates.HsmCertificate' \
                                        > <cluster ID>_HsmCertificate.crt
     ```

  1. Issue the following command to extract the AWS hardware certificate\. Replace *<cluster ID>* with the ID of the cluster that you created previously\.

     ```
     $ aws cloudhsmv2 describe-clusters --filters clusterIds=<cluster ID> \
                                        --output text \
                                        --query 'Clusters[].Certificates.AwsHardwareCertificate' \
                                        > <cluster ID>_AwsHardwareCertificate.crt
     ```

  1. Issue the following command to extract the manufacturer hardware certificate\. Replace *<cluster ID>* with the ID of the cluster that you created previously\.

     ```
     $ aws cloudhsmv2 describe-clusters --filters clusterIds=<cluster ID> \
                                        --output text \
                                        --query 'Clusters[].Certificates.ManufacturerHardwareCertificate' \
                                        > <cluster ID>_ManufacturerHardwareCertificate.crt
     ```

**To get the CSR and HSM certificates \(AWS CloudHSM API\)**

+ Send a [http://docs.aws.amazon.com/cloudhsm/latest/APIReference/API_DescribeClusters.html](http://docs.aws.amazon.com/cloudhsm/latest/APIReference/API_DescribeClusters.html) request, then extract and save the CSR and certificates from the response\.

### Get the Root Certificates<a name="get-root-certificates"></a>

Follow these steps to get the root certificates for AWS CloudHSM and the manufacturer\.

**To get the AWS CloudHSM and manufacturer root certificates**

1. Go to https://docs\.aws\.amazon\.com/cloudhsm/latest/userguide/root\-certificate\.html, and then choose **AWS\_CloudHSM\_Root\-G1\.zip**\. After you download the file, extract \(unzip\) its contents\.

1. Go to [https://www\.cavium\.com/LS/TAmanuCert/](https://www.cavium.com/LS/TAmanuCert/), and then choose **Download Certificate**\. You might need to right\-click the **Download Certificate** link and then choose **Save Link As\.\.\.** to save the certificate file\.

## Verify Certificate Chains<a name="verify-certificate-chains"></a>

Construct two certificate chains, one to the AWS CloudHSM root certificate and one to the manufacturer root certificate\. Then use OpenSSL to verify the HSM certificate with each certificate chain\.

**To verify the HSM certificate with the AWS CloudHSM root certificate**

1. Use the following command to create a certificate chain that includes the AWS hardware certificate and the AWS CloudHSM root certificate, in that order\. Replace *<cluster ID>* with the ID of the cluster that you created previously\.

   ```
   $ cat <cluster ID>_AwsHardwareCertificate.crt \
         AWS_CloudHSM_Root-G1.crt \
         > <cluster ID>_AWS_chain.crt
   ```

1. Use the following OpenSSL command to verify the HSM certificate with the AWS certificate chain\. Replace *<cluster ID>* with the ID of the cluster that you created previously\.

   ```
   $ openssl verify -CAfile <cluster ID>_AWS_chain.crt <cluster ID>_HsmCertificate.crt
   <cluster ID>_HsmCertificate.crt: OK
   ```

**To verify the HSM certificate with the manufacturer root certificate**

1. Use the following command to create a certificate chain that includes the manufacturer hardware certificate and the manufacturer root certificate, in that order\. Replace *<cluster ID>* with the ID of the cluster that you created previously\.

   ```
   $ cat <cluster ID>_ManufacturerHardwareCertificate.crt \
         cavium_cert.crt \
         > <cluster ID>_manufacturer_chain.crt
   ```

1. Use the following OpenSSL command to verify the HSM certificate with the manufacturer certificate chain\. Replace *<cluster ID>* with the ID of the cluster that you created previously\.

   ```
   $ openssl verify -CAfile <cluster ID>_manufacturer_chain.crt <cluster ID>_HsmCertificate.crt
   <cluster ID>_HsmCertificate.crt: OK
   ```

## Extract and Compare Public Keys<a name="compare-public-keys"></a>

Use OpenSSL to extract and compare the public keys in the HSM certificate and the cluster CSR, to ensure that they are the same\.

**To extract and compare the public keys**

1. Use the following command to extract the public key from the HSM certificate\.

   ```
   $ openssl x509 -in <cluster ID>_HsmCertificate.crt -pubkey -noout > <cluster ID>_HsmCertificate.pub
   ```

1. Use the following command to extract the public key from the cluster CSR\.

   ```
   $ openssl req -in <cluster ID>_ClusterCsr.csr -pubkey -noout > <cluster ID>_ClusterCsr.pub
   ```

1. Use the following command to compare the public keys\. If the public keys are identical, the following command produces no output\.

   ```
   $ diff <cluster ID>_HsmCertificate.pub <cluster ID>_ClusterCsr.pub
   ```

After you verify the identity and authenticity of the HSM, proceed to [Initialize the Cluster](initialize-cluster.md)\.